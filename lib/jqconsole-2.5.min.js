(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=function(a,b){return function(){return a.apply(b,arguments)}},v=Array.prototype.slice;a=jQuery,r=0,s=1,t=2,j=13,p=9,g=46,f=8,l=37,o=39,q=38,h=40,k=36,i=35,n=33,m=34,d=">>> ",c="... ",b=2,e=function(){function e(e,f,g,h){this._ProcessMatch=u(this._ProcessMatch,this),this.isMobile=!!navigator.userAgent.match(/iPhone|iPad|iPod|Android/i),this.isIos=!!navigator.userAgent.match(/iPhone|iPad|iPod/i),this.isAndroid=!!navigator.userAgent.match(/Android/i),this.$window=a(window),this.header=f||"",this.prompt_label_main=g||d,this.prompt_label_continue=" \n"+(h||c),this.indent_width=b,this.state=s,this.input_queue=[],this.input_callback=null,this.multiline_callback=null,this.history=[],this.history_index=0,this.history_new="",this.history_active=!1,this.shortcuts={},this.$console=a('<pre class="jqconsole"/>').appendTo(e),this.$console_focused=!0,this.$input_container=a("<div/>").appendTo(this.$console),this.$input_container.css({position:"relative",width:1,height:0,overflow:"hidden"}),this.$input_source=a("<textarea/>"),this.$input_source.attr("wrap","off").css({position:"absolute",width:2}),this.$input_source.appendTo(this.$input_container),this.matchings={openings:{},closings:{},clss:[]},this._InitPrompt(),this._SetupEvents(),this.Write(this.header,"jqconsole-header"),a(e).data("jqconsole",this)}e.prototype.Reset=function(){this.state!==s&&this.ClearPromptText(!0),this.state=s,this.input_queue=[],this.input_callback=null,this.multiline_callback=null,this.history=[],this.history_index=0,this.history_current="",this.shortcuts={},this.matchings={openings:{},closings:{},clss:[]},this.$prompt.detach(),this.$input_container.detach(),this.$console.html(""),this.$prompt.appendTo(this.$console),this.$input_container.appendTo(this.$console),this.Write(this.header,"jqconsole-header")},e.prototype._CheckKeyCode=function(a){isNaN(a)?a=a.charCodeAt(0):a=parseInt(a,10);if(0<a&&a<256&&!isNaN(a))return a;throw new Error("Key code must be a number between 0 and 256 exclusive.")},e.prototype._LetterCaseHelper=function(a,b){b(a),65<=a&&a<=90&&b(a+32);if(97<=a&&a<=122)return b(a-32)},e.prototype.RegisterShortcut=function(a,b){var c;a=this._CheckKeyCode(a);if(!b instanceof Function)throw new Error("Callback must be a function, not "+b+".");c=u(function(a){a in this.shortcuts||(this.shortcuts[a]=[]);return this.shortcuts[a].push(b)},this),this._LetterCaseHelper(a,c)},e.prototype.UnRegisterShortcut=function(a,b){var c;a=this._CheckKeyCode(a),c=u(function(a){if(a in this.shortcuts)return b?this.shortcuts[a].splice(this.shortcuts[a].indexOf(b),1):delete this.shortcuts[a]},this),this._LetterCaseHelper(a,c)},e.prototype.GetColumn=function(){var a;this.$prompt_cursor.text(""),a=this.$console.text().split("\n"),this.$prompt_cursor.html("&nbsp;");return a[a.length-1].length},e.prototype.GetLine=function(){return this.$console.text().split("\n").length-1},e.prototype.ClearPromptText=function(a){if(this.state===s)throw new Error("ClearPromptText() is not allowed in output state.");this.$prompt_before.html(""),this.$prompt_after.html(""),this.$prompt_label.text(a?"":this._SelectPromptLabel(!1)),this.$prompt_left.text(""),this.$prompt_right.text("")},e.prototype.GetPromptText=function(b){var c,d,e,f,g;if(this.state===s)throw new Error("GetPromptText() is not allowed in output state.");if(b){this.$prompt_cursor.text(""),g=this.$prompt.text(),this.$prompt_cursor.html("&nbsp;");return g}f=function(b){var c;c=[],b.children().each(function(){return c.push(a(this).children().last().text())});return c.join("\n")},d=f(this.$prompt_before),d&&(d+="\n"),e=this.$prompt_left.text()+this.$prompt_right.text(),c=f(this.$prompt_after),c&&(c="\n"+c);return d+e+c},e.prototype.SetPromptText=function(a){if(this.state===s)throw new Error("SetPromptText() is not allowed in output state.");this.ClearPromptText(!1),this._AppendPromptText(a),this._ScrollToEnd()},e.prototype.Write=function(b,c,d){var e;d==null&&(d=!0),e=a("<span/>")[d?"text":"html"](b),c!=null&&e.addClass(c),e.insertBefore(this.$prompt),this._ScrollToEnd(),this.$prompt_cursor.detach().insertAfter(this.$prompt_left)},e.prototype.Input=function(a){var b,c,d;if(this.state===t)c=this.input_callback,d=this.multiline_callback,b=this.history_active,this.AbortPrompt(),this.input_queue.unshift(u(function(){return this.Prompt(b,c,d)},this));else if(this.state!==s){this.input_queue.push(u(function(){return this.Input(a)},this));return}this.history_active=!1,this.input_callback=a,this.multiline_callback=null,this.state=r,this.$prompt.attr("class","jqconsole-input"),this.$prompt_label.text(this._SelectPromptLabel(!1)),this.Focus(),this._ScrollToEnd()},e.prototype.Prompt=function(a,b,c,d){this.state!==s?this.input_queue.push(u(function(){return this.Prompt(a,b,c)},this)):(this.history_active=a,this.input_callback=b,this.multiline_callback=c,this.async_multiline=d,this.state=t,this.$prompt.attr("class","jqconsole-prompt"),this.$prompt_label.text(this._SelectPromptLabel(!1)),this.Focus(),this._ScrollToEnd())},e.prototype.AbortPrompt=function(){if(this.state!==t)throw new Error("Cannot abort prompt when not in prompt state.");this.Write(this.GetPromptText(!0)+"\n","jqconsole-old-prompt"),this.ClearPromptText(!0),this.state=s,this.input_callback=this.multiline_callback=null,this._CheckInputQueue()},e.prototype.Focus=function(){this.$input_source.focus()},e.prototype.SetIndentWidth=function(a){return this.indent_width=a},e.prototype.GetIndentWidth=function(){return this.indent_width},e.prototype.RegisterMatching=function(a,b,c){var d;d={opening_char:a,closing_char:b,cls:c},this.matchings.clss.push(c),this.matchings.openings[a]=d;return this.matchings.closings[b]=d},e.prototype.UnRegisterMatching=function(a,b){var c;c=this.matchings.openings[a].cls,delete this.matchings.openings[a],delete this.matchings.closings[b];return this.matchings.clss.splice(this.matchings.clss.indexOf(c),1)},e.prototype._CheckInputQueue=function(){if(this.input_queue.length)return this.input_queue.shift()()},e.prototype._InitPrompt=function(){this.$prompt=a('<span class="jqconsole-input"/>').appendTo(this.$console),this.$prompt_before=a("<span/>").appendTo(this.$prompt),this.$prompt_current=a("<span/>").appendTo(this.$prompt),this.$prompt_after=a("<span/>").appendTo(this.$prompt),this.$prompt_label=a("<span/>").appendTo(this.$prompt_current),this.$prompt_left=a("<span/>").appendTo(this.$prompt_current),this.$prompt_right=a("<span/>").appendTo(this.$prompt_current),this.$prompt_right.css({position:"relative"}),this.$prompt_cursor=a('<span class="jqconsole-cursor">&nbsp;</span>'),this.$prompt_cursor.insertBefore(this.$prompt_right),this.$prompt_cursor.css({color:"transparent",display:"inline",zIndex:0});if(!this.isMobile)return this.$prompt_cursor.css("position","absolute")},e.prototype._SetupEvents=function(){var b,c,d;c={X:null,Y:null},this.$console.mousedown(u(function(a){c.X=a.pageX;return c.Y=a.pageY},this)),this.$console.mouseup(u(function(a){if(c.X===a.pageX&&c.Y===a.pageY){a.preventDefault();return this.Focus()}},this)),this.$input_source.focus(u(function(){var a,b;this.$console_focused=!0,this.$console.removeClass("jqconsole-blurred"),b=u(function(){if(this.$console_focused)return this.$console.removeClass("jqconsole-blurred")},this),setTimeout(b,100),a=u(function(){if(this.isIos&&this.$console_focused)return this.$input_source.hide()},this);return setTimeout(a,500)},this)),this.$input_source.blur(u(function(){var a;this.$console_focused=!1,this.isIos&&this.$input_source.show(),a=u(function(){if(!this.$console_focused)return this.$console.addClass("jqconsole-blurred")},this);return setTimeout(a,100)},this)),d=a.browser.opera?"input":"paste",this.$input_source.bind(d,u(function(){var a;a=u(function(){this._AppendPromptText(this.$input_source.val()),this.$input_source.val("");return this.Focus()},this);return setTimeout(a,0)},this)),this.$input_source.keypress(u(function(a){return this._HandleChar(a)},this)),b=a.browser.mozilla?"keypress":"keydown",this.$input_source[b](u(function(a){return this._HandleKey(a)},this));if(this.isMobile){this.$console.bind("touchend",u(function(){return this.$console[0].ontouchmove=null},this));return this.$console.bind("touchstart",u(function(a){var b;b={distanceX:null,distanceY:null};return this.$console[0].ontouchmove=u(function(a){var c,d,e,f,g;if(a.touches.length!==2)return!0;f=Math.abs(a.touches[0].pageX-a.touches[1].pageX),g=Math.abs(a.touches[0].pageX-a.touches[1].pageY);if(b.distanceX&&b.distanceY){d=Math.abs(f-b.distanceX),e=Math.abs(g-b.distanceY),c=d>e?f>b.distanceX:g>b.distanceY,c?this._HistoryPrevious():this._HistoryNext();return this.$console[0].ontouchmove=null}b.distanceX=f;return b.distanceY=g},this)},this))}},e.prototype._HandleChar=function(b){var c;if(this.state===s)return!0;c=b.which;if(c===13||c===9)return!1;if(a.browser.mozilla)if(b.keyCode||b.metaKey||b.ctrlKey||b.altKey)return!0;if(a.browser.opera)if(b.keyCode||b.which||b.metaKey||b.ctrlKey||b.altKey)return!0;if(b.metaKey||b.ctrlKey||b.altKey)return!1;this.$prompt_left.text(this.$prompt_left.text()+String.fromCharCode(c)),this._ScrollToEnd();return!1},e.prototype._HandleKey=function(b){var c;if(this.state===s)return!0;c=b.keyCode||b.which,setTimeout(a.proxy(this._CheckMatchings,this),0);if(b.altKey||b.metaKey&&!b.ctrlKey)return!0;if(b.ctrlKey)return this._HandleCtrlShortcut(c);if(b.shiftKey){switch(c){case j:this._HandleEnter(!0);break;case p:this._Unindent();break;case q:this._MoveUp();break;case h:this._MoveDown();break;case n:this._ScrollUp();break;case m:this._ScrollDown();break;default:return!0}return!1}switch(c){case j:this._HandleEnter(!1);break;case p:this._Indent();break;case g:this._Delete(!1);break;case f:this._Backspace(!1);break;case l:this._MoveLeft(!1);break;case o:this._MoveRight(!1);break;case q:this._HistoryPrevious();break;case h:this._HistoryNext();break;case k:this.MoveToStart(!1);break;case i:this.MoveToEnd(!1);break;case n:this._ScrollUp();break;case m:this._ScrollDown();break;default:return!0}return!1},e.prototype._HandleCtrlShortcut=function(a){var b,c,d,e;switch(a){case g:this._Delete(!0);break;case f:this._Backspace(!0);break;case l:this._MoveLeft(!0);break;case o:this._MoveRight(!0);break;case q:this._MoveUp();break;case h:this._MoveDown();break;case i:this.MoveToEnd(!0);break;case k:this.MoveToStart(!0);break;default:if(a in this.shortcuts){e=this.shortcuts[a];for(c=0,d=e.length;c<d;c++)b=e[c],b.call(this);return!1}return!0}return!1},e.prototype._HandleEnter=function(a){var b,c;if(a)return this._InsertNewLine(!0);c=this.GetPromptText(),b=u(function(a){var b,d,e,f,g;if(a!==!1){this.MoveToEnd(!0),this._InsertNewLine(!0),g=[];for(e=0,f=Math.abs(a);0<=f?e<f:e>f;0<=f?e++:e--)g.push(a>0?this._Indent():this._Unindent());return g}d=this.state===r?"input":"prompt",this.Write(this.GetPromptText(!0)+"\n","jqconsole-old-"+d),this.ClearPromptText(!0),this.history_active&&((!this.history.length||this.history[this.history.length-1]!==c)&&this.history.push(c),this.history_index=this.history.length),this.state=s,b=this.input_callback,this.input_callback=null,b&&b(c);return this._CheckInputQueue()},this);return this.multiline_callback?this.async_multiline?this.multiline_callback(c,b):b(this.multiline_callback(c)):b(!1)},e.prototype._GetDirectionals=function(b){var c,d,e,f,g,h,i,j;f=b?this.$prompt_left:this.$prompt_right,c=b?this.$prompt_right:this.$prompt_left,e=b?this.$prompt_before:this.$prompt_after,d=b?this.$prompt_after:this.$prompt_before,h=b?a.proxy(this.MoveToStart,this):a.proxy(this.MoveToEnd,this),g=b?a.proxy(this._MoveLeft,this):a.proxy(this._MoveRight,this),j=b?"last":"first",i=b?"prependTo":"appendTo";return{$prompt_which:f,$prompt_opposite:c,$prompt_relative:e,$prompt_rel_opposite:d,MoveToLimit:h,MoveDirection:g,which_end:j,where_append:i}},e.prototype._VerticalMove=function(a){var b,c,d,e,f,g,h,i;i=this._GetDirectionals(a),d=i.$prompt_which,b=i.$prompt_opposite,c=i.$prompt_relative,f=i.MoveToLimit,e=i.MoveDirection;if(!c.is(":empty")){g=this.$prompt_left.text().length,f(),e(),h=d.text(),b.text(a?h.slice(g):h.slice(0,g));return d.text(a?h.slice(0,g):h.slice(g))}},e.prototype._MoveUp=function(){return this._VerticalMove(!0)},e.prototype._MoveDown=function(){return this._VerticalMove()},e.prototype._HorizontalMove=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q;q=this._GetDirectionals(c),h=q.$prompt_which,e=q.$prompt_opposite,g=q.$prompt_relative,f=q.$prompt_rel_opposite,o=q.which_end,n=q.where_append,k=c?/\w*\W*$/:/^\w*\W*/,l=h.text();if(l){if(b){p=l.match(k);if(!p)return;p=p[0],m=e.text(),e.text(c?p+m:m+p),j=p.length;return h.text(c?l.slice(0,-j):l.slice(j))}m=e.text(),e.text(c?l.slice(-1)+m:m+l[0]);return h.text(c?l.slice(0,-1):l.slice(1))}if(!g.is(":empty")){i=a("<span/>")[n](f),i.append(a("<span/>").text(this.$prompt_label.text())),i.append(a("<span/>").text(e.text())),d=g.children()[o]().detach(),this.$prompt_label.text(d.children().first().text()),h.text(d.children().last().text());return e.text("")}},e.prototype._MoveLeft=function(a){return this._HorizontalMove(a,!0)},e.prototype._MoveRight=function(a){return this._HorizontalMove(a)},e.prototype._MoveTo=function(a,b){var c,d,e,f,g,h,i;h=this._GetDirectionals(b),e=h.$prompt_which,c=h.$prompt_opposite,d=h.$prompt_relative,g=h.MoveToLimit,f=h.MoveDirection;if(a){i=[];while(!d.is(":empty")||e.text()!=="")g(!1),i.push(f(!1));return i}c.text(this.$prompt_left.text()+this.$prompt_right.text());return e.text("")},e.prototype.MoveToStart=function(a){this._MoveTo(a,!0)},e.prototype.MoveToEnd=function(a){this._MoveTo(a,!1)},e.prototype._Delete=function(a){var b,c,d;c=this.$prompt_right.text();if(c){if(a){d=c.match(/^\w*\W*/);if(!d)return;d=d[0];return this.$prompt_right.text(c.slice(d.length))}return this.$prompt_right.text(c.slice(1))}if(!this.$prompt_after.is(":empty")){b=this.$prompt_after.children().first().detach();return this.$prompt_right.text(b.children().last().text())}},e.prototype._Backspace=function(b){var c,d,e;setTimeout(a.proxy(this._ScrollToEnd,this),0),d=this.$prompt_left.text();if(d){if(b){e=d.match(/\w*\W*$/);if(!e)return;e=e[0];return this.$prompt_left.text(d.slice(0,-e.length))}return this.$prompt_left.text(d.slice(0,-1))}if(!this.$prompt_before.is(":empty")){c=this.$prompt_before.children().last().detach(),this.$prompt_label.text(c.children().first().text());return this.$prompt_left.text(c.children().last().text())}},e.prototype._Indent=function(){var a;return this.$prompt_left.prepend(function(){var b,c;c=[];for(a=1,b=this.indent_width;1<=b?a<=b:a>=b;1<=b?a++:a--)c.push(" ");return c}.call(this).join(""))},e.prototype._Unindent=function(){var a,b,c,d;a=this.$prompt_left.text()+this.$prompt_right.text(),d=[];for(b=1,c=this.indent_width;1<=c?b<=c:b>=c;1<=c?b++:b--){if(!/^ /.test(a))break;this.$prompt_left.text()?this.$prompt_left.text(this.$prompt_left.text().slice(1)):this.$prompt_right.text(this.$prompt_right.text().slice(1)),d.push(a=a.slice(1))}return d},e.prototype._InsertNewLine=function(b){var c,d,e;b==null&&(b=!1),e=this._SelectPromptLabel(!this.$prompt_before.is(":empty")),c=a("<span/>").appendTo(this.$prompt_before),c.append(a("<span/>").text(e)),c.append(a("<span/>").text(this.$prompt_left.text())),this.$prompt_label.text(this._SelectPromptLabel(!0)),b&&(d=this.$prompt_left.text().match(/^\s+/))?this.$prompt_left.text(d[0]):this.$prompt_left.text("");return this._ScrollToEnd()},e.prototype._AppendPromptText=function(a){var b,c,d,e,f,g;c=a.split("\n"),this.$prompt_left.text(this.$prompt_left.text()+c[0]),f=c.slice(1),g=[];for(d=0,e=f.length;d<e;d++)b=f[d],this._InsertNewLine(),g.push(this.$prompt_left.text(b));return g},e.prototype._ScrollUp=function(){var a;a=this.$console[0].scrollTop-this.$console.height();return this.$console.stop().animate({scrollTop:a},"fast")},e.prototype._ScrollDown=function(){var a;a=this.$console[0].scrollTop+this.$console.height();return this.$console.stop().animate({scrollTop:a},"fast")},e.prototype._ScrollToEnd=function(){var a,b,c,d,e,f,g;b=this.$prompt_cursor.height(),g=this.$window.scrollTop(),f=this.$window.scrollLeft(),a=document.documentElement.clientHeight,d=this.$prompt_cursor.offset(),e=this.$prompt_cursor.position(),this.$console.scrollTop(this.$console[0].scrollHeight),this.$input_container.css({left:e.left,top:e.top}),c=d.top-2*b;if(this.isMobile&&typeof orientation!="undefined"&&orientation!==null){if(g<d.top||g>d.top)return this.$window.scrollTop(c)}else if(g+a<d.top||g>c)return this.$window.scrollTop(c)},e.prototype._SelectPromptLabel=function(a){return this.state===t?a?this.prompt_label_continue:this.prompt_label_main:a?"\n ":" "},e.prototype._outerHTML=function(b){return document.body.outerHTML?b.get(0).outerHTML:a("<div/>").append(b.eq(0).clone()).html()},e.prototype._Wrap=function(a,b,c){var d,e;e=a.html(),d=e.slice(0,b)+('<span class="'+c+'">'+e[b]+"</span>")+e.slice(b+1);return a.html(d)},e.prototype._WalkCharacters=function(a,b,c,d,e){var f,g,h;g=e?a.length:0,a=a.split(""),h=function(){var b,c,d,f;e?(d=a,a=2<=d.length?v.call(d,0,c=d.length-1):(c=0,[]),b=d[c++]):(f=a,b=f[0],a=2<=f.length?v.call(f,1):[]),b&&(g=g+(e?-1:1));return b};while(f=h()){f===b?d++:f===c&&d--;if(d===0)return{index:g,current_count:d}}return{index:-1,current_count:d}},e.prototype._ProcessMatch=function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p;n=c?[b.closing_char,b.opening_char]:[b.opening_char,b.closing_char],h=n[0],l=n[1],o=this._GetDirectionals(c),g=o.$prompt_which,f=o.$prompt_relative,i=1,j=!1,m=g.html(),c||(m=m.slice(1)),d&&c&&(m=m.slice(0,-1)),p=this._WalkCharacters(m,h,l,i,c),k=p.index,i=p.current_count,k>-1?(this._Wrap(g,k,b.cls),j=!0):(e=f.children(),e=c?Array.prototype.reverse.call(e):e,e.each(u(function(d,e){var f,g;f=a(e).children().last(),m=f.html(),g=this._WalkCharacters(m,h,l,i,c),k=g.index,i=g.current_count;if(k>-1){c||k--,this._Wrap(f,k,b.cls),j=!0;return!1}},this)));return j},e.prototype._CheckMatchings=function(b){var c,d,e,f,g,h,i;e=b?this.$prompt_left.text().slice(this.$prompt_left.text().length-1):this.$prompt_right.text()[0],i=this.matchings.clss;for(g=0,h=i.length;g<h;g++)c=i[g],a("."+c,this.$console).contents().unwrap();(d=this.matchings.closings[e])?f=this._ProcessMatch(d,!0,b):(d=this.matchings.openings[e])?f=this._ProcessMatch(d,!1,b):b||this._CheckMatchings(!0);if(b){if(f)return this._Wrap(this.$prompt_left,this.$prompt_left.html().length-1,d.cls)}else if(f)return this._Wrap(this.$prompt_right,0,d.cls)},e.prototype._HistoryPrevious=function(){if(!!this.history_active){if(this.history_index>0){this.history_index===this.history.length&&(this.history_new=this.GetPromptText());return this.SetPromptText(this.history[--this.history_index])}return}},e.prototype._HistoryNext=function(){if(!!this.history_active){if(this.history_index<this.history.length){if(this.history_index===this.history.length-1){this.history_index++;return this.SetPromptText(this.history_new)}return this.SetPromptText(this.history[++this.history_index])}return}},e.prototype.Dump=function(){var b,c;b=this.$console.find(".jqconsole-header").nextUntil(".jqconsole-prompt");return function(){var d,e,f;f=[];for(d=0,e=b.length;d<e;d++)c=b[d],f.push(a(c).is(".jqconsole-old-prompt")?a(c).text().replace(/^\s+/,">>> "):a(c).text());return f}().join(" ")},e.prototype.GetState=function(){return this.state===r?"input":this.state===s?"output":"prompt"};return e}(),a.fn.jqconsole=function(a,b,c){return new e(this,a,b,c)}}).call(this)